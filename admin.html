<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Parking Inteligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .plaza {
            width: 100px;
            height: 100px;
            margin: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .plaza.libre {
            background-color: #28a745;
            color: white;
        }
        .plaza.ocupada {
            background-color: #dc3545;
            color: white;
        }
        .barrera {
            width: 150px;
            height: 40px;
            margin: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .barrera.abierta {
            background-color: #28a745;
        }
        .barrera.cerrada {
            background-color: #dc3545;
        }
        .lcd-display {
            background-color: #20c997;
            color: black;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-family: monospace;
        }
        .led-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .led-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            transition: all 0.3s ease;
        }
        .led-indicator.on {
            background-color: #28a745;
            box-shadow: 0 0 10px #28a745;
        }
        .led-indicator.off {
            background-color: #dc3545;
            box-shadow: none;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2>Panel de Administración</h2>
                    <button class="btn btn-secondary" onclick="window.location.href='/'">Volver a Vista Principal</button>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Pantalla LCD</h5>
                        <div class="lcd-display">
                            <div id="lcd-line1">Bienvenido!</div>
                            <div id="lcd-line2">Plazas: 6/6</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Control de Barreras</h5>
                        <div class="d-flex justify-content-around">
                            <div>
                                <h6>Entrada</h6>
                                <button id="barrera-entrada" class="btn barrera cerrada" onclick="toggleBarrera('entrada')">Cerrada</button>
                            </div>
                            <div>
                                <h6>Salida</h6>
                                <button id="barrera-salida" class="btn barrera cerrada" onclick="toggleBarrera('salida')">Cerrada</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Control de Plazas y LEDs</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Estado de Plazas</h6>
                                <div class="d-flex flex-wrap" id="plazas-container">
                                    <!-- Las plazas se generarán dinámicamente -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Control de LEDs</h6>
                                <div id="leds-container">
                                    <!-- Los controles de LED se generarán dinámicamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Estadísticas</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Ocupación Actual</h6>
                                <div class="progress mb-3">
                                    <div id="ocupacion-progress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Plazas Disponibles</h6>
                                <h2 id="plazas-disponibles" class="text-center">6/6</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // Crear plazas
        const plazasContainer = document.getElementById('plazas-container');
        for (let i = 0; i < 6; i++) {
            const plaza = document.createElement('div');
            plaza.className = 'plaza libre';
            plaza.id = `plaza-${i + 1}`;
            plaza.textContent = i + 1;
            plaza.onclick = () => togglePlaza(i);
            plazasContainer.appendChild(plaza);
        }

        // Crear controles de LED
        const ledsContainer = document.getElementById('leds-container');
        for (let i = 0; i < 6; i++) {
            const ledControl = document.createElement('div');
            ledControl.className = 'led-control';
            ledControl.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="led-indicator on" id="led-${i + 1}"></div>
                    <span>LED Plaza ${i + 1}</span>
                </div>
                <button class="btn btn-sm btn-primary" onclick="toggleLed(${i})">Cambiar</button>
            `;
            ledsContainer.appendChild(ledControl);
        }

        // Funciones de control
        function toggleBarrera(tipo) {
            const barrera = document.getElementById(`barrera-${tipo}`);
            const nuevoEstado = barrera.classList.contains('cerrada');
            socket.emit('toggleBarrera', { barrera: tipo, estado: nuevoEstado });
        }

        function toggleLed(plaza) {
            const led = document.getElementById(`led-${plaza + 1}`);
            const nuevoEstado = !led.classList.contains('on');
            socket.emit('toggleLed', { plaza: plaza + 1, estado: nuevoEstado });
        }

        function togglePlaza(plaza) {
            const plazaElement = document.getElementById(`plaza-${plaza + 1}`);
            const nuevoEstado = plazaElement.classList.contains('ocupada');
            socket.emit('togglePlaza', { plaza: plaza + 1, estado: nuevoEstado });
        }

        // Actualizar estado
        socket.on('status', (state) => {
            // Actualizar LCD
            document.getElementById('lcd-line1').textContent = state.lcd.line1;
            document.getElementById('lcd-line2').textContent = state.lcd.line2;

            // Actualizar plazas
            state.plazas.forEach((libre, i) => {
                const plaza = document.getElementById(`plaza-${i + 1}`);
                plaza.className = `plaza ${libre ? 'libre' : 'ocupada'}`;
            });

            // Actualizar LEDs
            state.leds.forEach((encendido, i) => {
                const led = document.getElementById(`led-${i + 1}`);
                led.className = `led-indicator ${encendido ? 'on' : 'off'}`;
            });

            // Actualizar barreras
            const barreraEntrada = document.getElementById('barrera-entrada');
            barreraEntrada.className = `btn barrera ${state.barreras.entrada ? 'abierta' : 'cerrada'}`;
            barreraEntrada.textContent = state.barreras.entrada ? 'Abierta' : 'Cerrada';

            const barreraSalida = document.getElementById('barrera-salida');
            barreraSalida.className = `btn barrera ${state.barreras.salida ? 'abierta' : 'cerrada'}`;
            barreraSalida.textContent = state.barreras.salida ? 'Abierta' : 'Cerrada';

            // Actualizar estadísticas
            const plazasLibres = state.plazas.filter(p => p).length;
            const ocupacion = ((6 - plazasLibres) / 6) * 100;
            document.getElementById('ocupacion-progress').style.width = `${ocupacion}%`;
            document.getElementById('ocupacion-progress').textContent = `${ocupacion.toFixed(1)}%`;
            document.getElementById('plazas-disponibles').textContent = `${plazasLibres}/6`;
        });
    </script>
</body>
</html>